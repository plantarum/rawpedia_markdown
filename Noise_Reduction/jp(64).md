<span style="color: #000000; background: none; overflow: hidden; page-break-after: avoid; font-size: 2.0em; font-family: Georgia,Times,serif; margin-top: 1em; margin-bottom: 0.25em; line-height: 1.3; padding: 0; border-bottom: 1px solid #AAAAAA;">ノイズ低減
</span>

## イントロダクション

<figure>
<img src="Noise-cactus-0-ba.png" title="Noise-cactus-0-ba.png" />
<figcaption>Noise-cactus-0-ba.png</figcaption>
</figure>

　写真撮影は露光中にカメラの中の媒体に当たる光を記録することが出発点となります。典型的な媒体はフィルム或いはデジタルセンサーです。しかし、媒体が光から受けるシグナルと媒体が記録するシグナルは全く同じものではなく、その違いのためノイズが発生します。フィルム及びデジタル写真撮影はノイズ（フィルムの場合は“グレイン“と呼ばれます）の影響を受けますが、ノイズには特定の要因や媒体によって様々な種類があります。

　ノイズを効果的に軽減するために、どの様なノイズが存在するのか、またどの様な場合に発生するのかを知っておくことは有益です。ノイズに関しては、RawTherapeeの開発者の一人、エンリコ・フェルミ研究所の物理学教授、Emil
J Martinec氏による詳細説明があります：[Noise, Dynamic Range and Bit
Depth in Digital SLRs](http://rawtherapee.com/mirror/noise/)

　ユーザーが求めるノイズ低減効果は、その人によって違います。完全なノイズ除去による、滑らかな画像が好きな人もいれば、フィルム調の質感を残したいと思う人もいます。RawTherapee
の*ノイズ低減*機能は、これらのニーズに応えるべく、画像の細部を保ちながらノイズを除去します。\[<https://ja.wikipedia.org/wiki/%E3%82%A6%E3%82%A7%E3%83%BC%E3%83%96%E3%83%AC%E3%83%83%E3%83%88%E5%A4%89%E6%8F%9B>　ウェーブレット変換\]と\[<https://ja.wikipedia.org/wiki/%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%A4%89%E6%8F%9B>　フーリエ変換\]を駆使して調整しますが、どの様に仕上げるかは、貴方次第です。効果的な調整を行うための説明が以下にあります。

## この機能の扱い方

　ノイズ低減を行う以前に、ノイズの非常に多い高ISO画像を補正する場合は、デモザイク処理の方式に、AMaZEではなく、LMMSEやIGVを使うことをお奨めします。これらアルゴリズムは、誤ったメイズパターンの発生と、ノイズ低減機能を強くした場合に起こる画像の色褪せを抑えることが出来るからです。

高ISO画像に対する最良のノイズ低減設定は、以下を心掛けるといいでしょう：

1.  まず、シャープ化機能をチェックし、微細な部分をシャープ化するような設定になっていないことを確認します。何故なら、ノイズの多い画像には良質な微細部分が無いからです。この様な場合、細部のシャープ化を行うことは、ノイズを増幅させるだけです。ディテールレベルのコントラスト機能を使う場合は、一番目の“0”スライダー（細かい）、多くの場合は次の“1”スライダーも、はオフにします。
2.  画像を100％に拡大し、画像の中で、ぴったり焦点が合っている部分と、焦点の合っていない大きめの部分を見つけておくことです。ノイズ低減の作業において、それらを使って画像を確認し、細部の質を落とさないようにします。
3.  初め、“輝度　細部の復元”のスライダーは0にしておきます。
4.  輝度スライダーだけで補正を行うか、それとも輝度カーブも使ってより細かな補正も行うかどうか決めます。そして、スライダー或いはカーブを、輝度ノイズが消えて滑らかになるまで調節します。
5.  輝度ノイズが消えたので（細部の復元はまだ0のままです）、色ノイズの有無が分り易くなっているはずです。ここから：
    1.  手動で行う場合は、色の詳細が失われない程度に、“色（マスター）”のスライダーを使って、色ノイズを除去します。“色差（レッド／グリーン）”と“色差（ブルー／イエロー）”のスライダーで、レッド／グリーンとブルー／イエローに対するノイズ低減を別々に行うことも出来ます。
    2.  自動で行うことも出来ます。
6.  そして、最後に*輝度　細部の復元*のスライダーを使って、ノイズ低減と細部の喪失という相反関係を考慮
    しながら、満足なレベルまで細部を回復させます。

## インターフェイスの説明

### 方式

　ノイズ低減機能はRGB色空間でも、Lab色空間でも使えます。Lab空間で使えば、輝度と色を切り離して扱うことが出来るという有利性はありますが、輝度ノイズだけの補正（“*輝度*”と“*輝度　細部の復元*”のスライダー）であれば、通常、色空間の違いによる効果の差は無視できる程度です。色ノイズ低減（“*色（マスター）*”のスライダー）を強く使った場合は、違いが出るでしょう。

　RGBとLabモードを切り替える時は、細部がしっかりした彩度の高い大きな部分、例えばTシャツの色模様や花びらなど、を注意深く確認してみて下さい。

\<gallery caption="ノイズ低減の方式の比較" perrow="4"\|
style="text-align: center"\> Image:Rt noisereduction 1
off-vs-rgb.jpg\|ノイズ低減無効と有効 (RGBモード) Image:Rt noisereduction
2 rgb-vs-lab.jpg\|RGB対Lab Image:Rt noisereduction 3 lmmse
off-vs-rgb.jpg\|ノイズ低減無効と有効 (RGBモード) Image:Rt noisereduction
4 lmmse rgb-vs-lab.jpg\|RGB対Lab

</gallery>

### ノイズ低減の質

　“高い”はノイズ低減の行程を、異なるアルゴリズムで2回行います。その代わり処理時間が増えます。
　“環境設定→パフォーマンスとクォリティ”でウェーブレット変換のレベルを変えられます。

- レベルは上げない
- レベルを1或いは2にする。処理時間は増えますが、色ノイズ低減の質は向上します、特に“パケット”と呼ばれる醜い色ノイズを減らします。

### 輝度パネル

#### 輝度ノイズの低減

　輝度ノイズ低減には2つの方法があります。スライダーかカーブのどちらかを使います。相互作用はしません。

#### 輝度スライダー

　このスライダーで、輝度ノイズによる粗い部分を滑らかに調整します。

#### 輝度カーブ

![](Rt_nr_luminancecurve_books.jpg "Rt_nr_luminancecurve_books.jpg")
　このカーブでより正確な部分を目標にしてノイズ低減を行います、よってシャドウ部分の輝度ノイズに対し強いノイズ低減を施す一方でハイライト部分ではノイズ低減を行わないように調整出来ます。一般的にノイズはハイライト部分よりシャドウ部分に多いので、これは望ましい機能です。カーブとスライダーはそれぞれ単独で使います。同時には使えません。

#### 輝度　細部の復元

　輝度ノイズの使用後、失われた細部を回復させるスライダーです。設定値を極端に大きくしない限り、ノイズを再発せずに、細部の構造だけを復元します。

### 色パネル

#### 方式

　選択出来る方式の種類は、“環境設定→パフォーマンスとクオリティ→ツールのモード”で選択されるモード次第で、3つ、或いは4つになります：

##### ツールのモードで“標準”を選んだ場合の方式選択

- 手動
- 自動（分割方式）
- 自動（プレビュー方式）

##### ツールのモードで“高度”を選んだ場合の方式選択

- 手動
- 自動（分割方式）
- 自動（多分割方式）
- 自動（プレビュー多分割方式）

##### プレビューのノイズ

　“プレビューのノイズ”は、“色ノイズ”低減処理後の、色ノイズの推定値を示す機能です。

- 中間色度：全色チャンネルの色ノイズを合計し、そこから算出した平均値です。
- 高色度：全色チャンネルの中から推定される最大の色ノイズ値です。

##### 手動

　3つのスライダーと色ノイズ低減のカーブで、色ノイズを手動で除去します。画像全体に作用します。

###### 色（マスター）

　ノイズ低減機能をカラーチャンネルに適用するスライダーです。この設定値が0～5の時は、色差スライダーの効果がありません。

###### 色差（レッド／グリーン）

　レッド／グリーンチャンネル（Labのa\*）対する、色ノイズ低減の効果を高めたり低めたりします。

###### 色差（ブルー／イエロー）

　ブルー／イエローチャンネル（Labのb\*）対する、色ノイズ低減の効果を高めたり低めたりします。

##### 自動（分割方式）

- このノイズ低減アルゴリズムは画像全体に作用します。画像の中に任意のセルを9つ設け、各セルに対して：
  - レッド/グリーンチャンネルとブルー/イエローチャンネルの色ノイズの平均を求めます。
  - 同じチャンネルで、色ノイズの最大値を求めます。

<!-- -->

- 画像にセルが9つ設けられない場合（画像サイズが小さ過ぎる）は、“環境設定→パフォーマンスとクオリティ→セルのサイズ”で、セルのサイズを変更して下さい：
  - 最小は100x115、小は250x287、中はタイルの半分のサイズ（デフォルト設定）、最大はタイルと同サイズです。
  - タイルはノイズ低減処理が行われる単位区分を指しますが、その数でRAMの使用量も変わります。タイル一枚のサイズは縦横約700ピクセルです。
  - セルの大きさにはメリット・デメリットがあります：
    - セルの大きさが小さければ、その分処理時間が短くなります。画像が均質であれば、小さいセルが使えます。
    - 逆に、セルが大きくなれば、処理時間は増えますが、より精度の高いノイズ低減処理が期待できます。

<!-- -->

- セルの大きさだけでなく、ノイズ低減処理のレベルも変えることが出来ます。“環境設定→パフォーマンスとクオリティ→ノイズ低減のレベル”で“標準”或いは“低”（デフォルト設定）を選べます。

<!-- -->

- 処理のレベルを変えると、処理の比重が変わり3つのスライダー（マスター、レッド/グリーン、ブルー/イエロー）値も変わります。“プレビューのノイズ”で表示される値が更新されます。

<!-- -->

- “プレビュー画面の画像”の映りが、TIFFやJPEG出力画像の映りに近くなるでしょう。

<!-- -->

- 3つのスライダーの設定値は、プレビュー画面の画像が全体画像の何処を表示していても変わることはありません。

<!-- -->

- 設定値はpp3ファイル（処理プロファイル）には保存されません。同じ設定値を他の画像に使うために保存するには、“手動”モードに切り替える必要があります。

##### プレビュー方式

- このモードは、プレビューでの画像表示を100％、或いはそれ以上にしないと使えません。作用は画像全体に及びます。
- プレビューの拡大率を変えると、ノイズ低減の再計算が自動的に行われます。
- このモードはプレビューに表示されている画像部分だけを対象にノイズ低減のための計算を行います：レッド/グリーンチャンネルとブルー/イエローチャンネルで、ノイズの平均値と最大値を計算します。
- 従って、プレビュー画像の移動で、異なる画像部分のノイズ低減が可能です。
- 3つのスライダー、及び“プレビューのノイズ”はプレビュー画像の移動に合わせて更新されます。
- 選択された画像で行われたノイズ低減設定は画像全体の処理に使われます。
- 出力画像をTIFFやJPEG形式にする場合は、プレビュー画像の映りが出力画像と同じになります。
- “自動”モードの利用を奨めますが、選択した画像部分で行ったノイズ低減設定を他の画像に使いたい場合は、モードを一旦“手動”に変えれば処理プロファイルに保存することが出来ます。
- 但し、環境設定で行った“ノイズ低減のレベル”が同一であることが条件です。

##### 自動（多分割方式）

- このモードが使える（環境設定で“ノイズ低減のレベル”を標準にすることが必要）のは、出力画像がTIFFとJPEG形式の場合だけです。
- このモードの効果は“プレビュー”画面で完全に反映させることは出来ませんが、以下に説明されている“プレビュー（多分割方式）を補助的に使い、画像の色々な部分をプレビューでチェックすれば、最終画像の仕上がりをかなり正確に推測出来るでしょう。
- “自動（多分割方式）”モードでは、ノイズ低減の区分にタイルを使いますので、その枚数に応じてメモリーの使用量が異なります。
- 画像を縦横約500～800ピクセルのタイルで分割します。分割はプログラムが自動で行います。
- タイルの枚数は、画像のサイズと、“環境設定→パフォーマンスとクオリティ→タイルの枚数”の設定で、12枚～120枚に決まります。
- タイルの設定時にタイルが重なり合う部分もありますが、隣接するタイルと違いがあっても心配には及びません。
- “環境設定→パフォーマンスとクオリティ”の設定に従ったタイルは、それぞれ個別にレッド/グリーン、ブルー/イエローチャンネルでノイズ低減が施されます。仮に、120枚のタイル全てを手動で処理するとしたら、それぞれマスター、レッド/グリーン、ブルー/イエローチャンネルで120回の異なる処理をすることになります。
- つまり、一枚のタイルを一つの画像として捉え、タイルの枚数と同じ回数の処理を行うということです。
- 但し、“環境設定→パフォーマンスとクオリティ→自動（多分割方式）のスムージング）”というオプションで、この処理を加減することが可能です。選択肢は4つあります：
  - なし：上記で説明された処理が全て実行される。
  - 低：他のタイルで行われる処理の一部が軽減されますが、その度合いは非常に低いというモード
  - 高：“低”より、度合いが高いモード
  - 最高‐全てのタイルの平均値を適用する：このモードは、“自動（分割方式）の様に作用しますが、9つのセルの代わりに、12～120枚のタイルを使うところが違います。
- “環境設定→パフォーマンスとクオリティ”の設定全てがこのモードには関係します。

##### プレビュー（多分割方式）

- プレビューのモードと同じです。
- しかし、このモードはその“プレビューのノイズ”を補助的に使えば、“自動（多分割方式）の効果を非常に近い形で確認することが出来ます。
- “プレビューのノイズ：中間色度=xx　高色度=yy”という下に、2つのラインが表示されます：
  - 初めのラインは、タイルサイズのピクセル数と全画像の中心位置を表示しています。
  - 次のラインは、プレビューサイズのピクセル数と全画像の中心位置です。プレビューのサイズは、拡大率、ウィンドウの横幅で決まります。
  - プレビュー画像を動かしたり、画像サイズを変えたりして、プレビューの中心位置とサイズをタイルに合わせて下さい。但し、ノイズ低減を実行中に、強い不連続性が発生することは非常に稀なので、数値がピッタリ合わなくとも十数ピクセルの違いであれば効果の確認に差は出ません。

##### 色ノイズ低減のカーブ

　このカーブで、より正確に特定部分のノイズ低減が行えます。

- 周知のように、L\*a\*b\*モードの色度とは、色の強さを示す数値です。低色度はグレーや冴えない色であることを意味し、高色度は彩度の強い色を意味します。
- この色ノイズ低減のカーブは、“マスター、レッド/グリーン、ブルー/イエロー”のスライダーの効果をカーブが作る乗数で加減します。
- 例えば、手動モードで、マスタースライダーが30にセットされている時に、カーブの高さが中間にあれば、マスタースライダーの効果は45と同じになります。
- このカーブは、色ノイズの調整方式（手動、自動（分割方式）、自動（多分割方式）、プレビュー方式）が何であっても使用が可能です。
- プログラムのデフォルト設定は、色ノイズの調整法が“自動（分割方式）”ですが、平均値で処理を行うため、色度の低い部分で効果が弱い場合があります。その様な場合、このカーブを使って効果を高めることが出来ます。色度の低い部分でノイズが目立つのはあまり嬉しくありませんが、彩度が強い部分では、ノイズのレベルが同じでも比較的目立ちません。
- 備考：スライダー作用の補完として、メディアンフィルターの“色ノイズだけ”を使用することがあります。これは、ウェーブレット変換の値が高くなり過ぎること（画像が色褪せる印象）を避けるために使います。

### ガンマ

　ガンマはノイズ低減が画像のどの色調で効果を高めるのか調整します。設定値が低い時
はシャドー部分の全ての色調で効果が高まります。高い設定値では、シャドー部分の
明るい部分だけで効果を高めます。

### メディアン

<img src="Rt_nr_median_books.jpg" title="Rt_nr_median_books.jpg"
width="900" alt="Rt_nr_median_books.jpg" />
　このフィルターは、上記のノイズ低減作用後に残った、小さく、はっきりしたアーティファクトを除去するのに使います。この[メディアンフィルター](https://en.wikipedia.org/wiki/Median_filter)（英語）、各ピクセルを周辺ピクセルのメディアン値に置き換えるものです。周辺ピクセルのパターンは“ウィンドウ”と呼ばれるもので、画像全体に渡りフィルターをピクセル単位でスライドさせます。ウィンドウのサイズは、“フィルターの種類”のドロップボックスから選びます。大きいサイズを選ぶと処理時間が長くなります。

使用出来るウィンドウのサイズは:

- 3x3：　1ピクセル範囲で5ピクセルを処理


○●○

●●●

○●○

- 強い3x3：　1ピクセル範囲で9ピクセルを処理


●●●

●●●

●●●

- 5x5：　2ピクセル範囲で13ピクセルを処理


○○●○○

○●●●○

●●●●●

○●●●○

○○●○○

- 強い5x5：　2ピクセル範囲で25ピクセルを処理


●●●●●

●●●●●

●●●●●

●●●●●

●●●●●

- 7x7：　3ピクセル範囲で49ピクセルを処理


●●●●●●●

●●●●●●●

●●●●●●●

●●●●●●●

●●●●●●●

●●●●●●●

●●●●●●●

- 9x9：　4ピクセル範囲で81ピクセルを処理


●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

●●●●●●●●●

　小さいウィンドウを使った機能の繰り返しの方が、大きいウィンドウを一回だけ使った時より、効果が高い場合もあります。

　“輝度のみ”と“Lab”モードを使った場合、メディアンフィルターは、ノイズ低減行程の中のウェーブレット変換が行われた後に使われます。“RGB”モードの場合は、ノイズ低減の最終工程で使われます。

![](Rt_nr_median_zoom_books.jpg "Rt_nr_median_zoom_books.jpg")
　周辺ピクセルと値が大きく異なるピクセルを除去する以外に、このフィルター使用に何の意味があるのか疑問に思う人もいるでしょう。その効果の一つは、画像をJPEGやPNGに圧縮する際、ファイルサイズを減らせることです。メディアンフィルターは、画像データ圧縮の際にどのみち失われてしまうピクセルの値の差を除去します。また、これらの差は、画像を印刷した場合、恐らく見えないものです。これらの差を除去することで、ファイルサイズが40％減ることもあります（JPEG圧縮率を92に設定した“バランスの取れた質”\[<https://en.wikipedia.org/wiki/Chroma_subsampling>　クロマサブサンプリング\]（英語）でテストした結果）。試してみて下さい。

　“色ノイズだけ”というメディアンフィルターは、ウェーブレット変換による処理を補完するために使えます。画像の詳細部分が色褪せないよう、処理に適用される変換値を下げます。

#### 方式

　必要に応じて使い分けられるよう5つの方式を用意しました：

- 輝度のみ：L\*a\*b\*色空間を使いますが、作用するのは輝度（L）チャンネルに対してだけです。
- 色ノイズだけ：L\*a\*b\*色空間を使いますが、作用するのはa\*チャンネルとb\*チャンネルに対してだけです。
- a\*b\*の比重は普通に、L\*チャンネルの比重だけ少なくします。L\*a\*b\*色空間を使います。
- L\*a\*b\*：L\*、a\*、b\*の3チャンネルで均等に作用します。
  L\*a\*b\*色空間を使います。
- GB：RGB色空間を使います。但し、使えるフィルターは3x3、強い3x3、5x5だけです。